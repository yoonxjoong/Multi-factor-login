# Multi-factor-login
Spring Security 아이디/패스워드 + 구글 Authenticator 인증을 이용한 샘플 로그인 화면 

개발하면서 공부한 내용 / 이슈 같은 내용을 한번더 정리하는 느낌으로 프로젝트 생성하여 기록합니다.  
싱글 페이지에서 아이디/패스워드 + 구글 Authenticator 인증하는 내용은 오픈소스로 많이 알려져 있으나, 멀티 페이지로 페이지를 이동해 가면서 로그인이 되는 소스는 없는거 같아 정리를 합니다.
스프링부트 2.6에서 개발을 하였으며 샘플 프로젝트는 3.2.4 최신 버전으로 업그레이드 하여 프로젝트를 작성합니다.

- 기존 프로젝트에서 Spring Security를 활용해서 ID/PW 기반 로그인이 구현되어 있음
- 고객 요구 사항이 기존 로그인 인증 성공 후 구글 Authenticator 기능을 구현하여 멀티 팩터 인증을 요청함.
- Spring boot 2.6에서 개발을 하면서 Spring boot 3.0 빌드업을 하여 샘플 프로젝트를 작성


### 기능
- 1차 인증
  - ID / PW 로그인
  - 1차 로그인 성공시 2차 로그인 화면으로 이동
  - 기존 접근 가능했던 페이지는 접근이 차단됨
  - 1차 로그인 화면, 2차 로그인 화면에만 접근을 할 수 있음

- 2차 인증
  - 구글 Authenticator 생성
  - 구글 Authenticator 인증에 따라 로그인 여부 결정
  - 2차 로그인 성공 후 메인페이지 접속 가능

    
### Spring Security MFA
- 요구사항
    - ID/Password 1차 인증 후 Google Authenticator 2차 인증을 수행
    - 페이지를 분리하여 인증을 수행
- 흐름도
    1. 로그인 페이지
    2. ID/PW 입력 후 로그인 시도
    3. AuthenticationProvider 에서 1차 인증 처리
    4. 1차 인증 후 Authentication 의 권한 생성 (IS_AUTHENTICATED_HALF)
    5. Google Authenticator 2차 인증 페이지로 리다이렉션
    6. AuthenticationProvider 에서 2차 인증 처리
    7. 2차 인증 후 Authentication의 권한 생성 (IS_AUTHENTICATED_FULLY)
    8. 루트페이지로 이동

    
##### 트러블슈팅 1
- 문제 발견
  - 1차 인증 후 인증 토큰이 생성됨, 루트 페이지로 이동하면 이동이 허용됨
  - 기존 루트 페이지로 접근했을 떄 인증이 완료되면 내부 페이지 진입, 인증이 안되거나 실패면 로그인페이지로 리다이렉션 (AuthenticationEntryPoint - 인증이 없을 경우 리다이렉션을 해줌)
      - AuthenticationEntryPoint : 인증 예외 발생 시 핸들링하는 인터페이스
  - 1차, 2차 인증이 추가되면서 1차 인증 후 spring boot에서는 인증이 완료된걸로 인식 (인증이 되었지만 전체 권한이 없음)
  - 사용자가 URL 루트(/) 로 접근하면 에러 페이지로 접근 (권한은 IS_AUTHENTICATED_FULLY이 아니기 떄문)

- 해결 방안
  - 필터를 등록하여 루트(/) 페이지로 접근한 요청은 권한에 따라 리다이렉션 처리를 추가함
  - 최종 인증이 완료 되면 메인페이지로 이동, 1차 인증만 성공시에는 로그인 페이지로 이동함


##### 트러블슈팅 2
- 문제 발견
  - 1차 로그인 성공 후 세션 타임이 기존과 동일해서 세션을 유지하고 있음
  - 2차 로그인 까지 세션을 가지고 있음 (보안적으로 문제가 될것으로 보임)
  - 고객에 요구사항에 요청에 따라 변경할 필요가 있음
  - 현재 레디스에 세션이 저장되고 있음

- 해결 방안
  - 1차 로그인 성공 후 세션 타임아웃을 기존 타임아웃보다 짧게 변경함 (레디스에도 업데이트)
  - 2차 로그인 성공 후 세션 타임 아웃을 기존에 사용하던 타임아웃으로 다시 변경함


##### History
24.04.16
- 로그인 페이지 구현